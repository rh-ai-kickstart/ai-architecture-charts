# Containerfile for MCP Store Server (Direct DB Access)

FROM registry.access.redhat.com/ubi9/python-311:latest

# Add metadata labels for better container management
LABEL org.opencontainers.image.title="MCP DBStore Server"
LABEL org.opencontainers.image.description="FastMCP server providing database-backed product inventory tools"
LABEL org.opencontainers.image.version="0.0.1"
LABEL org.opencontainers.image.source="https://github.com/yourusername/ai-virtual-assistant"
LABEL org.opencontainers.image.documentation="https://github.com/yourusername/ai-virtual-assistant/tree/main/mcpservers/mcp_dbstore"

WORKDIR /app

# UBI Python images already have curl-minimal which is sufficient for health checks
# No need to install additional packages

# Copy the source code from the src directory
# Build context is mcp-servers/store_db/
COPY ./src /app/mcp_dbstore

# Install Python dependencies
RUN pip install --no-cache-dir -r /app/mcp_dbstore/requirements.txt

# Environment variables with defaults
# Main database connection URL - should be overridden at runtime
ENV DATABASE_URL="postgresql+asyncpg://mcpuser:mcppassword@postgres-service:5432/store_db"

# Ensures Python can find the mcp_dbstore package from the /app directory
ENV PYTHONPATH=/app

# Additional environment variables for configuration
ENV MCP_SERVER_PORT=8002
ENV MCP_SERVER_HOST=0.0.0.0
ENV MCP_SERVER_TRANSPORT=sse

# UBI Python images run as non-root by default

# Expose the correct port that matches store.py
EXPOSE 8002

# Health check to ensure the server is running properly
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8002/healthz || exit 1

# Command to run the MCP server
CMD ["python", "-m", "mcp_dbstore.store"]
